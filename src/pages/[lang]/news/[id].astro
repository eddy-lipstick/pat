---
// src/pages/[lang]/news/[id].astro
import { getCollection, getEntry } from 'astro:content';
import { render } from 'astro:content';

import BaseLayout from '@/layouts/BaseLayout.astro';
import Hero from '@/components/Hero.astro';
import Breadcrumb from '@/components/Breadcrumb';
import { languages } from '@/i18n/config';
import { newsTranslations } from '@/i18n/translations/news';
import { ArrowLeft, ArrowRight } from 'lucide-react';

export async function getStaticPaths() {
  const allNews = await getCollection('news');

  return Object.keys(languages).flatMap((lang) => {
    // Change this line - we're checking either the folder structure or the language field
    const languageNews = allNews.filter(
      (item) => item.id.startsWith(`${lang}/`) || item.data.language === lang
    );

    return languageNews.map((entry) => ({
      params: {
        lang,
        // Fix the ID extraction to handle both folder structures
        id: entry.id.split('/').pop()?.replace('.md', '') || entry.id.replace('.md', ''),
      },
      props: { entry },
    }));
  });
}

const { entry } = Astro.props;
const { lang } = Astro.params;
const t = newsTranslations[lang];
const { Content } = await render(entry);

// Format date in correct language
const formattedDate = new Date(entry.data.date).toLocaleDateString(
  lang === 'nl' ? 'nl-NL' : 'en-US',
  {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }
);

const breadcrumbItems = [
  { label: t.breadcrumbs.about, href: `/${lang}/about` },
  { label: t.breadcrumbs.news, href: `/${lang}/news` },
  { label: entry.data.title },
];

// Get all news posts for current language and sort them
const allNews = await getCollection('news');
const languageNews = allNews.filter((item) => item.data.lang === lang);
const sortedNews = languageNews.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Find current post index
const currentIndex = sortedNews.findIndex((post) => post.id === entry.id);
const prevNews = currentIndex < sortedNews.length - 1 ? sortedNews[currentIndex + 1] : null;
const nextNews = currentIndex > 0 ? sortedNews[currentIndex - 1] : null;

// Format date helper function
const formatDate = (dateString: string) => {
  return new Intl.DateTimeFormat(lang === 'nl' ? 'nl-NL' : 'en-US', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  }).format(new Date(dateString));
};
---

<BaseLayout title={`${entry.data.title}`}>
  <Breadcrumb items={breadcrumbItems} client:load />

  <Hero
    variant="small"
    subtitle={formattedDate}
    title={entry.data.title}
    description={entry.data.summary}
  >
    {
      entry.data.image && (
        <div class="w-full aspect-[16/9] lg:aspect-auto lg:h-full">
          <img
            src={entry.data.image.src}
            alt={entry.data.image.alt}
            class="w-full h-full object-cover rounded-lg"
          />
        </div>
      )
    }
  </Hero>

  <div class="flex justify-start mt-12">
    <article class="prose prose-invert max-w-[50ch]">
      <Content />
    </article>
  </div>

  <!-- Navigation -->
  <nav class="grid grid-cols-2 gap-4 border-t border-border/50 pt-8 mt-20">
    {
      prevNews && (
        <a
          href={`/${lang}/news/${prevNews.id.split('/').pop()?.replace('.md', '')}`}
          class="group flex items-center gap-3 hover:text-primary transition-colors"
        >
          <ArrowLeft className="h-4 w-4" />
          <div>
            <div class="text-sm text-text-secondary">{formatDate(prevNews.data.date)}</div>
            <div class="font-medium group-hover:text-primary transition-colors">
              {prevNews.data.title}
            </div>
          </div>
        </a>
      )
    }

    {
      nextNews && (
        <a
          href={`/${lang}/news/${nextNews.id.split('/').pop()?.replace('.md', '')}`}
          class="group flex items-center justify-end gap-3 hover:text-primary transition-colors ml-auto"
        >
          <div class="text-right">
            <div class="text-sm text-text-secondary">{formatDate(nextNews.data.date)}</div>
            <div class="font-medium group-hover:text-primary transition-colors">
              {nextNews.data.title}
            </div>
          </div>
          <ArrowRight className="h-4 w-4" />
        </a>
      )
    }
  </nav>
</BaseLayout>

<style>
  .prose {
    --tw-prose-headings: theme('colors.text.primary');
    --tw-prose-body: theme('colors.text.secondary');
    --tw-prose-bold: theme('colors.text.primary');
    --tw-prose-quotes: theme('colors.text.secondary');
    --tw-prose-quote-borders: theme('colors.primary.DEFAULT');
    --tw-prose-captions: theme('colors.text.tertiary');
    --tw-prose-hr: theme('colors.surface.2');
    --tw-prose-links: theme('colors.primary.DEFAULT');
    --tw-prose-counters: theme('colors.text.tertiary');
    --tw-prose-bullets: theme('colors.text.tertiary');
  }

  .prose :deep(h1),
  .prose :deep(h2),
  .prose :deep(h3),
  .prose :deep(h4) {
    scroll-margin-top: 100px;
  }

  .prose :deep(a) {
    text-decoration-line: none;
    border-bottom: 1px solid theme('colors.primary.DEFAULT');
    transition: border-color 0.2s ease;
  }

  .prose :deep(a:hover) {
    border-color: transparent;
  }
</style>
